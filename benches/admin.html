<script>
    let pendingBenchesData = [];
    let approvedBenchesData = [];
    let users = [];
    let currentFilter = 'pending';

    // Funktion zum Umschalten zwischen den Haupt-Tabs (Bänke und Bilder)
    function showAdminTab(tab) {
        const benchesContent = document.getElementById('benchesContent');
        const imagesContent = document.getElementById('imagesContent');
        const benchesTabBtn = document.getElementById('benchesTab');
        const imagesTabBtn = document.getElementById('imagesTab');
        const filterTabs = document.querySelector('.filter-tabs');

        if (tab === 'benches') {
            imagesContent.style.display = 'none';
            benchesContent.style.display = 'block';
            benchesTabBtn.classList.add('active');
            imagesTabBtn.classList.remove('active');
            if (filterTabs) filterTabs.style.display = 'flex';
            loadData();
        } else {
            benchesContent.style.display = 'none';
            imagesContent.style.display = 'block';
            benchesTabBtn.classList.remove('active');
            imagesTabBtn.classList.add('active');
            if (filterTabs) filterTabs.style.display = 'none';
            loadPendingImages();
        }
    }

    async function loadData() {
        try {
            // Korrigierte URL von 'get_pending_benches' zu 'get-pending-benches'
            const pendingRes = await fetch('/.netlify/functions/get-pending-benches');
            pendingBenchesData = await pendingRes.json();
            
            // Läd die genehmigten Bänke für die Statistik
            const approvedRes = await fetch('/.netlify/functions/get-approved-benches');
            approvedBenchesData = await approvedRes.json();

            updateStats();
            displayBenches();
        } catch (e) {
            alert('Fehler beim Laden der Bänke.');
            console.error(e);
        }
    }

    function updateStats() {
        document.getElementById('pendingCount').textContent = pendingBenchesData.length;
        document.getElementById('approvedCount').textContent = approvedBenchesData.length;
        // Die Nutzerzahl ist nicht Teil der aktuellen Logik, daher bleibt sie bei 0
        document.getElementById('totalUsers').textContent = users.length;
    }

    function showTab(filter, event) {
        currentFilter = filter;
        document.querySelectorAll('.filter-tabs .tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        displayBenches();
    }

    function displayBenches() {
        const container = document.getElementById('benchesList');
        let benchesToShow = [];

        switch(currentFilter) {
            case 'pending':
                // Ordnet die Daten aus der API der Benutzeroberfläche zu
                benchesToShow = pendingBenchesData.map(b => ({
                    ...b, 
                    approved: false,
                    // Feldnamen-Mapping von DB-Schema zu UI-Schema
                    lat: b.latitude,
                    lng: b.longitude,
                    benchImage: b.bench_image,
                    viewImage: b.view_image,
                    user: b.user_email,
                    created: b.created_at
                }));
                break;
            case 'approved':
                benchesToShow = approvedBenchesData.map(b => ({...b, approved: true}));
                break;
            case 'all':
                benchesToShow = [
                    ...pendingBenchesData.map(b => ({...b, approved: false})),
                    ...approvedBenchesData.map(b => ({...b, approved: true}))
                ].sort((a, b) => new Date(b.created) - new Date(a.created));
                break;
        }

        if (benchesToShow.length === 0) {
            container.innerHTML = `
                <div class="no-benches">
                    <h3>Keine Bänke ${currentFilter === 'pending' ? 'wartend' : currentFilter === 'approved' ? 'genehmigt' : 'vorhanden'}</h3>
                    <p>Es gibt derzeit keine Bänke in dieser Kategorie.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = benchesToShow.map(bench => `
            <div class="bench-card ${bench.approved ? 'approved' : ''}">
                <div class="bench-header">
                    <div class="bench-title">${escapeHtml(bench.name)}</div>
                    <div class="bench-status ${bench.approved ? 'status-approved' : 'status-pending'}">
                        ${bench.approved ? '✅ Genehmigt' : '⏳ Wartend'}
                    </div>
                </div>
                
                <div class="bench-info">
                    <div>
                        <strong>Beschreibung:</strong><br>
                        ${escapeHtml(bench.description)}
                    </div>
                    <div>
                        <strong>Position:</strong> ${bench.lat}, ${bench.lng}<br>
                        <strong>Eingereicht von:</strong> ${escapeHtml(bench.user || 'Unbekannt')}<br>
                        <strong>Erstellt am:</strong> ${new Date(bench.created).toLocaleString()}
                    </div>
                    <div style="margin-top: 10px;">
                        <img src="${bench.benchImage || ''}" alt="Bank Bild" style="max-width: 120px; max-height: 80px; object-fit: cover; border-radius: 4px;">
                        <img src="${bench.viewImage || ''}" alt="Ansicht Bild" style="max-width: 120px; max-height: 80px; object-fit: cover; border-radius: 4px; margin-left: 10px;">
                    </div>
                </div>

                <div class="bench-actions">
                    ${!bench.approved ? `
                        <button onclick="approveBench(${bench.id})" class="btn btn-approve">Genehmigen</button>
                        <button onclick="rejectBench(${bench.id})" class="btn btn-reject">Ablehnen</button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }

    async function approveBench(id) {
        if (!confirm('Diese Bank genehmigen?')) return;
        try {
            const res = await fetch('/.netlify/functions/approve_bench', {
                method: 'POST',
                body: JSON.stringify({ id }),
                headers: { 'Content-Type': 'application/json' }
            });
            if (!res.ok) throw new Error('Fehler beim Genehmigen');
            await loadData();
        } catch (e) {
            alert('Fehler beim Genehmigen der Bank.');
            console.error(e);
        }
    }

    async function rejectBench(id) {
        if (!confirm('Diese Bank ablehnen und löschen?')) return;
        try {
            const res = await fetch('/.netlify/functions/reject_bench', {
                method: 'POST',
                body: JSON.stringify({ id }),
                headers: { 'Content-Type': 'application/json' }
            });
            if (!res.ok) throw new Error('Fehler beim Ablehnen');
            await loadData();
        } catch (e) {
            alert('Fehler beim Ablehnen der Bank.');
            console.error(e);
        }
    }

    function refreshData() {
        loadData();
    }

    function escapeHtml(text) {
        return text
            ? text.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
            : '';
    }

    // NEUE Funktionen für die Bildverwaltung
    async function loadPendingImages() {
        const list = document.getElementById('imagesList');
        list.innerHTML = 'Lade wartende Bilder...';
        try {
            const response = await fetch('/.netlify/functions/get-pending-images');
            const images = await response.json();
            
            list.innerHTML = '';
            if (images.length === 0) {
                list.innerHTML = '<p>Keine wartenden Bilder gefunden.</p>';
                return;
            }

            images.forEach(img => {
                const card = document.createElement('div');
                card.className = 'image-review-card';
                card.innerHTML = `
                    <div class="image-header">
                        <h4>Neues Bild für: ${img.benchName}</h4>
                        <p>Eingereicht am: ${new Date(img.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="image-comparison">
                        <div class="image-box">
                            <h5>Neues Bild</h5>
                            <img src="${img.imageUrl}" alt="Neues Bild" onclick="openFullscreen('${img.imageUrl}')">
                            <p>Beschreibung: ${img.description || 'Keine Angabe'}</p>
                        </div>
                        <div class="image-box">
                            <h5>Aktuelle Bank-Bilder</h5>
                            <img src="${img.benchImage}" alt="Bankbild" onclick="openFullscreen('${img.benchImage}')">
                            <img src="${img.viewImage}" alt="Aussichtsbild" onclick="openFullscreen('${img.viewImage}')">
                        </div>
                    </div>
                    <div class="image-actions">
                        <button class="btn btn-approve" onclick="approveImage('${img.id}')">✔️ Genehmigen</button>
                        <button class="btn btn-reject" onclick="rejectImage('${img.id}')">❌ Ablehnen</button>
                    </div>
                `;
                list.appendChild(card);
            });

        } catch (error) {
            console.error('Fehler beim Laden der Bilder:', error);
            list.innerHTML = '<p>Fehler beim Laden der wartenden Bilder.</p>';
        }
    }

    async function approveImage(id) {
        if (!confirm('Möchten Sie dieses Bild wirklich genehmigen?')) return;
        const response = await fetch('/.netlify/functions/approve-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        if (response.ok) {
            alert('Bild erfolgreich genehmigt.');
            loadPendingImages();
        } else {
            alert('Fehler beim Genehmigen des Bildes.');
        }
    }

    async function rejectImage(id) {
        if (!confirm('Möchten Sie dieses Bild wirklich ablehnen?')) return;
        const response = await fetch('/.netlify/functions/reject-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            if (response.ok) {
                alert('Bild erfolgreich abgelehnt.');
                loadPendingImages();
            } else {
                alert('Fehler beim Ablehnen des Bildes.');
            }
        }

    // Initialer Aufruf
    document.addEventListener('DOMContentLoaded', () => {
        // Stellt sicher, dass das erste Tab aktiv ist, und lädt die Daten
        showAdminTab('benches'); // Geändert, damit Bänke standardmäßig angezeigt werden
    });

    // Initial laden
    loadData();
</script>
